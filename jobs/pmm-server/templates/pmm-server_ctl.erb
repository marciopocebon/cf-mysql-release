#!/bin/bash

set -e
set -o pipefail

LOG_DIR=/var/vcap/sys/log/pmm-server
LOG_FILE=$LOG_DIR/pmm-server_ctrl.combined.log
PROC_NAME=pmm-server
RUN_DIR=/var/vcap/sys/run/$PROC_NAME
PIDFILE=$RUN_DIR/$PROC_NAME.pid

source /var/vcap/packages/cf-mysql-common/pid_utils.sh

case $1 in
  start)
    echo "start script: starting pmm-server_ctrl..."

    service docker restart | grep process | awk '{print $4}' > $PIDFILE

    docker create \
      -v /opt/prometheus/data \
      -v /opt/consul-data \
      -v /var/lib/mysql \
      -v /var/lib/grafana \
      --name pmm-data \
      percona/pmm-server:1.0.7 /bin/true

    docker run -d \
      -p 80:80 \
      --volumes-from pmm-data \
      --name pmm-server \
      --restart always \
      -e SERVER_PASSWORD=<%=p("pmm.admin_password")%> \
      percona/pmm-server:1.0.7

    echo "start script: started pmm-server_ctrl..."

    ;;

  stop)
    echo "stop script: stopping pmm-server_ctrl..."

    kill_and_wait $PIDFILE
    echo "stop script: stopped pmm-server_ctrl..."
    ;;

  *)
    echo "Usage: mysql_ctl {start|stop}"
    ;;

esac
